minimum_cumulusci_version: '4.6.0'
project:
    name: npc-exploration
    package:
        name: npc-exploration
        api_version: '64.0'
    git:
        default_branch: 'main'
    source_format: sfdx

tasks:

  # ===========================
  # Permissions & Access Setup
  # ===========================

  assign_psl_kitchen_sink:
    group: NPC Permissions & Access
    description: Assigns basically every PSL that looked relevant to NPC for the scratch org definition. This should be revised as requirements become clearer.
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSetLicenses 
    options:
      api_names:
        - AccountingSubledgerAdminPsl
        - AccountingSubledgerAutomationPsl
        - AccountingSubledgerGrowthBasePsl
        - ActionPlansPsl
        - AnalyticsQueryServicePsl
        - BenefitDisbursementPermissionSetLicense
        - BenefitManagementPermissionSetLicense
        - CarePlansPermissionSetLicense
        - CaseProceedingsPSL
        - CaseReferralPsl
        - ComplaintsManagementPsl
        - CompliantDataSharingPsl
        - DataProcessingEnginePsl
        - DocumentChecklistPsl
        - DynamicAssessmentPsl
        - EinsteinAnalyticsPlusPsl
        - EvidenceManagementPSL
        - FieldServiceDispatcherPsl
        - FieldServiceMobilePsl
        - FieldServiceSchedulingPsl
        - FieldServiceStandardPsl
        - FundraisingAccessPsl
        - GrantmakingPsl
        - GroupMembershipPsl
        - IndustriesARCPsl
        - IndustriesAssessmentPsl
        - IndustriesInteractionSummaryPsl
        - IndustriesSalesExcellencePsl
        - IndustriesServiceExcellencePsl
        - InsightsBuilderPsl
        - LifeEventsAccessPSL
        - OmniStudioDesigner
        - OmniStudioRuntime
        - OutcomeManagementPsl
        - ProgramManagementPsl
        - Salesforce_org_AccountingSubledgerPsl
        - Salesforce_org_NonprofitCloudCaseManagementPsl
        - SonicEmbeddedStorePsl
        - SurveyCreatorPsl
        - Volunteer_Management_User

  assign_fundraising_perms:
    group: NPC Permissions & Access
    description: Assign all fundraising-related permission sets to the current user.
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSets
    options:
      api_names:
        - FundraisingAccess
        - Fundraising_Admin
        - Fundraising_User
        - GroupMembershipPsl
        - ManageAccountingSubledger

  assign_grantmaking_perms:
    group: NPC Permissions & Access
    description: Assign grantmaking-related permission sets to the current user.
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSets
    options:
      api_names:
        - Grantmaking_Manager
        - GrantmakingManager

  assign_casemgmt_perms:
    group: NPC Permissions & Access
    description: Assign all case management-related permission sets to the current user.
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSets
    options:
      api_names:
        - CarePlansPermissionSetLicense
        - AdvancedProgramManagement
        - Investigative_Case_Management_Officer
        - Social_Program_Management_Caseworker
        - Benefit_Management_Caseworker
        - OutcomeManagement
        - DocumentChecklist
        - CaseReferralPsl
        - IndustriesAssessmentPermissionSet
        - BenefitManagementPermissionSetLicense

  assign_volunteermgmt_perms:
    group: NPC Permissions & Access
    description: Assign all volunteer management-related permission sets to the current user.
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSets
    options:
      api_names:
        - Volunteer_Management_User
        - GroupMembershipPsl
        - ManageVolunteerData

  assign_volunteerquickstart_perms:
    group: NPC Permissions & Access
    description: Assign Volunteer Quick Start-specific permission sets to the current user.
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSets
    options:
      api_names:
        - VMQS_Custom_Fields


  # ===========================
  # UI / App Navigation Tweaks
  # ===========================

  reorder_app_menu:
    group: NPC App Menu
    description: Set the default org-wide app menu order for general NPC exploration.
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/ReorderAppMenu.cls
      apex: applyOrgAppOrder();

  reorder_app_menu_volunteering:
    group: NPC App Menu
    description: Set the app menu order optimized for volunteering workflows.
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/ReorderAppMenu.cls
      apex: applyVolunteerAppOrder();

  reorder_app_menu_fundraising:
    group: NPC App Menu
    description: Set the app menu order optimized for fundraising workflows.
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/ReorderAppMenu.cls
      apex: applyFundraisingAppOrder();

  reorder_app_menu_grantmaking:
    group: NPC App Menu
    description: Set the app menu order optimized for grantmaking workflows.
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/ReorderAppMenu.cls
      apex: applyGrantmakingAppOrder();

  reorder_app_menu_programs:
    group: NPC App Menu
    description: Set the app menu order optimized for program management workflows.
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/ReorderAppMenu.cls
      apex: applyProgramManagementAppOrder();


  # ===========================
  # Sample / Demo Data
  # ===========================

  load_group_membership_data:
    group: NPC Sample Data
    class_path: cumulusci.tasks.bulkdata.load.LoadData
    options:
      mapping: datasets/group_membership/group_membership_mapping.yml
      sql_path: datasets/group_membership/group_membership_data.sql

  load_fundraising_data:
    group: NPC Sample Data
    class_path: cumulusci.tasks.bulkdata.load.LoadData
    options:
      mapping: datasets/fundraising/fundraising_mapping.yml
      sql_path: datasets/fundraising/fundraising_data.sql

  load_volunteer_management_data:
    group: NPC Sample Data
    class_path: cumulusci.tasks.bulkdata.load.LoadData
    options:
      mapping: datasets/volunteer_management/volunteer_mapping.yml
      sql_path: datasets/volunteer_management/volunteer_data.sql

  load_case_management_data:
    group: NPC Sample Data
    description: Loads case and program management data. Remember to manually enable Program Cohorts and Benefit Disbursements first if you want the complete dataset.
    class_path: cumulusci.tasks.bulkdata.load.LoadData
    options:
      mapping: datasets/case_management/casemgmt_mapping.yml
      sql_path: datasets/case_management/casemgmt_data.sql
      drop_missing_schema: True

  load_grantmaking_data:
    group: NPC Sample Data
    class_path: cumulusci.tasks.bulkdata.load.LoadData
    options:
      mapping: datasets/grantmaking/grantmaking_mapping.yml
      sql_path: datasets/grantmaking/grantmaking_data.sql

  # ======================================
  # Volunteer Quick Start (VMSQ) Metadata
  # ======================================

  update_verification_status_values:
    group: NPC Volunteer Quick Start
    description: Add required Verification Status picklist values for Volunteer Quick Start.
    class_path: cumulusci.tasks.metadata_etl.AddValueSetEntries
    options:
      api_names: LPIPXMVerificationStatusTypeEnum
      entries:
        - fullName: Awaiting Approval
          label: Awaiting Approval
        - fullName: Pending
          label: Pending
        - fullName: Approved
          label: Approved
        - fullName: Not Approved
          label: Not Approved

  install_volunteer_quick_start_package:
    group: NPC Volunteer Quick Start
    description: Installs VMSQ package from Salesforce (https://github.com/SFDC-Assets/PSA-Volunteer-Management). To get install to succeed you must manually rename the Address/Examination layouts that conflict with unmanaged package install and enable History Tracking on Account. You shouldn't need to use this unless you want to compare the unpackaged metadata here with the original contents.
    class_path: cumulusci.tasks.salesforce.InstallPackageVersion
    options:  
      version: 04tfh000000ZNZd
      version_number: 1.3

  retrieve_volunteer_quick_start_components:
    group: NPC Volunteer Quick Start
    description: Retrieve all components in the VMSQ package from an org where it is installed (for comparison with unpackaged metadata).
    class_path: cumulusci.tasks.salesforce.RetrieveUnpackaged
    options:
      path: unpackaged/volunteersQuickStartRetrieve
      package_xml: unpackaged/volunteersQuickStartRetrieve/package.xml

  deploy_volunteers_quick_start_step1:
    group: NPC Volunteer Quick Start
    description: Deploy the first set of Volunteer Quick Start metadata (core objects and configuration).
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/volunteersQuickStart/step1

  deploy_volunteers_quick_start_step2:
    group: NPC Volunteer Quick Start
    description: Deploy the second set of Volunteer Quick Start metadata (remaining configuration).
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/volunteersQuickStart/step2

  

  # ======================================
  # Object & Field Metadata / References
  # ======================================

  list_org_objects:
    description: List API names and labels of every object in the org
    group: NPC Metadata Utilities
    class_path: tasks.list_org_objects.ListOrgObjects

  generate_object_reference:
    description: Generate a text data dictionary for selected objects.
    group: NPC Metadata Utilities
    class_path: tasks.object_reference.GenerateObjectReference

  generate_group_membership_reference:
    description: Generate a text data dictionary for household and group-related objects.
    options:
      objects: "Account,Contact,PartyRelationshipGroup,AccountContactRelation,AccountAccountRelation,ContactContactRelation,PartyRoleRelation"
      output_path: datasets/group_membership/group_membership_objects.yml

  generate_fundraising_object_reference:
    group: NPC Metadata Utilities
    description: Generate a text data dictionary for fundraising-related objects.
    class_path: tasks.object_reference.GenerateObjectReference
    options:
      objects: "Account,Contact,AccountContactRelation,Campaign,OutreachSourceCode,PaymentInstrument,GiftBatch,GiftDesignation,Opportunity,GiftCommitment,GiftCommitmentSchedule,GiftDefaultDesignation,GiftCmtChangeAttrLog,GiftTransaction,GiftTransactionDesignation,GiftRefund,GiftSoftCredit,GiftTribute,GiftEntry,Task"
      output_path: datasets/fundraising/fundraising_objects.yml

  generate_volunteer_object_reference:
    group: NPC Metadata Utilities
    description: Generate a text data dictionary for volunteer management-related objects.
    class_path: tasks.object_reference.GenerateObjectReference
    options:
      objects: "Account,Competency,JobPosition,JobPositionAssignment,JobPositionShift,Location,OperatingHours,PersonLocationAvailability,Position,PositionQualification,TimeSlot,VolunteerInitiative"
      output_path: datasets/volunteer_management/volunteer_objects.yml
  
  generate_group_membership_object_reference:
    group: NPC Metadata Utilities
    description: Generate a text data dictionary for household and party relationship group-related objects.
    class_path: tasks.object_reference.GenerateObjectReference
    options:
      objects: "Account,Contact,PartyRelationshipGroup,AccountContactRelation,AccountAccountRelation,ContactContactRelation,PartyRoleRelation"
      output_path: datasets/group_membership/group_membership_objects.yml

  generate_grantmaking_object_reference:
    group: NPC Metadata Utilities
    description: Generate a text data dictionary for grantmaking-related objects.
    class_path: tasks.object_reference.GenerateObjectReference
    options:
      objects: "User,Account,Contact,Contract,ApplicationDecision,ApplicationRenderMethod,ApplicationReview,ApplicationStageDefinition,ApplicationTimeline,PreliminaryApplicationRef,IndividualApplication,IndividualApplicationTask,PublicApplicationParticipant,DocumentChecklistItem,ActionPlanTemplate,ActionPlanTemplateVersion,ActionPlan,Budget,BudgetAllocation,BudgetCategory,BudgetCategoryValue,BudgetPeriod,FundingOpportunity,FundingAward,FundingAwardAmendment,FundingAwardRequirement,FundingAwardRqmtSection,FundingDisbursement,Program,OutcomeActivity,IndicatorAssignment,IndicatorPerformancePeriod"
      output_path: datasets/grantmaking/grantmaking_objects.yml

flows:

  # ===========================
  # Permission / Setup Flows
  # ===========================

  assign_all_npc_perms:
    group: NPC Permissions & Access
    description: Assign all NPC implementation guide-related permissions to the current user.
    steps:
      1:
        task: assign_fundraising_perms
      2:
        task: assign_grantmaking_perms
      3:
        task: assign_casemgmt_perms
      4:
        task: assign_volunteermgmt_perms


  # ===========================
  # Org Setup / Dev Flows
  # ===========================

  dev_org:
    group: Org Setup
    description: Base dev org setup including NPC permissions and default app menu ordering.
    steps:
      90: 
        flow: assign_all_npc_perms
      91: 
        task: reorder_app_menu    

  load_all_datasets:
    group: Org Setup
    description: Loads all datasets into a single org. This will take a while to run, so consider using 
      individual datasets if that's all you need.
    steps:
      1: 
        task: load_group_membership_data
      2: 
        task: load_fundraising_data
      3: 
        task: load_volunteer_management_data
      4: 
        task: load_case_management_data
      5: 
        task: load_grantmaking_data

  # ===========================
  # Volunteer Quick Start Flows
  # ===========================

  deploy_volunteer_quick_start:
    group: NPC Volunteer Quick Start
    description: Deploy the unpackaged Salesforce Volunteer Management Quick Start metadata.
    steps:
      1:
        task: update_verification_status_values
      2:
        task: assign_volunteermgmt_perms
      3:
        task: deploy_volunteers_quick_start_step1
      4:
        task: assign_volunteerquickstart_perms
      5:
        task: deploy_volunteers_quick_start_step2
      6: 
        task: reorder_app_menu
  
  volunteer_quick_start_org:
    group: Org Setup
    description: Create a dev org with NPC defaults and then deploy Volunteer Quick Start metadata.
    steps:
      1: 
        flow: dev_org
      2:
        flow: deploy_volunteer_quick_start
