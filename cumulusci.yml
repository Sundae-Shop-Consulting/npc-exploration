minimum_cumulusci_version: '4.6.0'
project:
    name: npc-exploration
    package:
        name: npc-exploration
        api_version: '64.0'
    git:
        default_branch: 'main'
    source_format: sfdx

tasks:
  # permissions
  assign_psl_kitchen_sink:
    description: Assigns basically every PSL that looked relevant to NPC for the scratch org definition. This should be revised as requirements become clearer.
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSetLicenses 
    options:
      api_names:
        - AccountingSubledgerAdminPsl
        - AccountingSubledgerAutomationPsl
        - AccountingSubledgerGrowthBasePsl
        - ActionPlansPsl
        - AnalyticsQueryServicePsl
        - BenefitDisbursementPermissionSetLicense
        - BenefitManagementPermissionSetLicense
        - CarePlansPermissionSetLicense
        - CaseProceedingsPSL
        - CaseReferralPsl
        - ComplaintsManagementPsl
        - CompliantDataSharingPsl
        - DataProcessingEnginePsl
        - DocumentChecklistPsl
        - DynamicAssessmentPsl
        - EinsteinAnalyticsPlusPsl
        - EvidenceManagementPSL
        - FieldServiceDispatcherPsl
        - FieldServiceMobilePsl
        - FieldServiceSchedulingPsl
        - FieldServiceStandardPsl
        - FundraisingAccessPsl
        - GrantmakingPsl
        - GroupMembershipPsl
        - IndustriesARCPsl
        - IndustriesAssessmentPsl
        - IndustriesInteractionSummaryPsl
        - IndustriesSalesExcellencePsl
        - IndustriesServiceExcellencePsl
        - InsightsBuilderPsl
        - LifeEventsAccessPSL
        - OmniStudioDesigner
        - OmniStudioRuntime
        - OutcomeManagementPsl
        - ProgramManagementPsl
        - Salesforce_org_AccountingSubledgerPsl
        - Salesforce_org_NonprofitCloudCaseManagementPsl
        - SonicEmbeddedStorePsl
        - SurveyCreatorPsl
        - Volunteer_Management_User

  assign_fundraising_perms:
    description: Assign all fundraising-related permission sets to the current user
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSets
    options:
      api_names:
        - FundraisingAccess
        - Fundraising_Admin
        - Fundraising_User
        - GroupMembershipPsl

  assign_grantmaking_perms:
    description: Assign all grantmaking-related permission sets to the current user
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSets
    options:
      api_names:
        - Grantmaking_Manager
        - Grantmaking_Applicant
        - GrantmakingManager

  assign_casemgmt_perms:
    description: Assign all case management-related permission sets to the current user
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSets
    options:
      api_names:
        - CarePlansPermissionSetLicense
        - AdvancedProgramManagement
        - Investigative_Case_Management_Officer
        - Social_Program_Management_Caseworker
        - Benefit_Management_Caseworker
        - OutcomeManagement
        - DocumentChecklist

  assign_volunteermgmt_perms:
    description: Assign all volunteer management-related permission sets to the current user
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSets
    options:
      api_names:
        - Volunteer_Management_User
        - GroupMembershipPsl

  assign_volunteerquickstart_perms:
    description: Assign all volunteer management-related permission sets to the current user
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSets
    options:
      api_names:
        - VMQS_Custom_Fields

  # ui
  reorder_app_menu:
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/ReorderAppMenu.cls
      apex: applyOrgAppOrder();

  # sample data
  load_sample_data:
    class_path: cumulusci.tasks.sample_data.load_sample_data.LoadSampleData
    options:
      snowfakery_recipe: datasets/default/default.recipe.yml

  # volunteer quick start setup
  update_verification_status_values:
    class_path: cumulusci.tasks.metadata_etl.AddValueSetEntries
    options:
      api_names: LPIPXMVerificationStatusTypeEnum
      entries:
        - fullName: Awaiting Approval
          label: Awaiting Approval
        - fullName: Pending
          label: Pending
        - fullName: Approved
          label: Approved
        - fullName: Not Approved
          label: Not Approved

  delete_conflicting_layouts:
    description: Delete Address/Examination layouts that conflict with unmanaged package install
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/layoutCleanup
    
  install_quick_start_package:
    description: Package from https://github.com/SFDC-Assets/PSA-Volunteer-Management
    class_path: cumulusci.tasks.salesforce.InstallPackageVersion
    options:  
      version: 04tfh000000ZNZd
      version_number: 1.3

  retrieve_package_components:
    class_path: cumulusci.tasks.salesforce.RetrieveUnpackaged
    options:
      path: unpackaged/volunteersQuickStartRetrieve
      package_xml: unpackaged/volunteersQuickStartRetrieve/package.xml

  deploy_step1:
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/volunteersQuickStart/step1

  deploy_step2:
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/volunteersQuickStart/step2

  deploy_all_retrieved:
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/volunteersQuickStart/step2
  
  deploy_volunteer_quick_start_components:
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/volunteersQuickStartRetrieve



flows:
  assign_all_npc_perms:
    description: Assign all NPC implementation-guide permissions to me
    steps:
      1:
        task: assign_fundraising_perms
      #2:
        # task: assign_grantmaking_perms
      3:
        task: assign_casemgmt_perms
      4:
        task: assign_volunteermgmt_perms

  deploy_volunteer_quick_start:
    description: Deploys content's of Salesforce's open source Volunteer Management Quick Start
    steps:
      1:
        task: update_verification_status_values
      2:
        task: deploy_volunteer_quick_start_components

  dev_org:
    steps:
      90: 
        flow: assign_all_npc_perms
      91: 
        task: reorder_app_menu

  volunteer_org:
    steps:
      1: 
        flow: dev_org
      2: 
        flow: deploy_volunteer_quick_start

  deploy_volunteer_partial:
    steps:
      1:
        task: assign_volunteermgmt_perms
      2:
        task: deploy_step1
      3:
        task: assign_volunteerquickstart_perms
      4:
        task: update_verification_status_values
      5:
        task: deploy_step2
      