minimum_cumulusci_version: '4.6.0'
project:
    name: npc-exploration
    package:
        name: npc-exploration
        api_version: '64.0'
    git:
        default_branch: 'main'
    source_format: sfdx

tasks:

  # ===========================
  # Permissions & Access Setup
  # ===========================

  assign_psl_kitchen_sink:
    group: NPC Permissions & Access
    description: Assigns basically every PSL that looked relevant to NPC for the scratch org definition. This should be revised as requirements become clearer.
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSetLicenses 
    options:
      api_names:
        - AccountingSubledgerAdminPsl
        - AccountingSubledgerAutomationPsl
        - AccountingSubledgerGrowthBasePsl
        - ActionPlansPsl
        - AnalyticsQueryServicePsl
        - BenefitDisbursementPermissionSetLicense
        - BenefitManagementPermissionSetLicense
        - CarePlansPermissionSetLicense
        - CaseProceedingsPSL
        - CaseReferralPsl
        - ComplaintsManagementPsl
        - CompliantDataSharingPsl
        - DataProcessingEnginePsl
        - DecisionExplainerPSL
        - DocumentChecklistPsl
        - DynamicAssessmentPsl
        - EinsteinAnalyticsPlusPsl
        - EvidenceManagementPSL
        - FundraisingAccessPsl
        - GrantmakingPsl
        - GroupMembershipPsl
        - IndustriesARCPsl
        - IndustriesAssessmentPsl
        - IndustriesInteractionSummaryPsl
        - IndustriesSalesExcellencePsl
        - IndustriesServiceExcellencePsl
        - IndustriesVisitPsl 
        - InsightsBuilderPsl
        - LifeEventsAccessPSL
        - OmniStudioDesigner
        - OmniStudioRuntime
        - OutcomeManagementPsl
        - ProgramManagementPsl
        - Salesforce_org_AccountingSubledgerPsl
        - Salesforce_org_NonprofitCloudCaseManagementPsl
        - SonicEmbeddedStorePsl
        - SurveyCreatorPsl

  assign_service_excellence_perms:
    group: NPC Permissions & Access
    description: Assign Industries Service Excellence permission sets
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSets
    options:
      api_names:
        - IndustriesServiceExcellence      
        - ActionableSegmentation           
        - IndustriesVisit                  

  assign_omnistudio_perms:
    group: NPC Permissions & Access
    description: Assign OmniStudio permission sets
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSets
    options:
      api_names:
        - OmniStudioAdmin                
        - OmniStudioExecution            
        - OmniStudioUser                 

  assign_analytics_perms:
    group: NPC Permissions & Access  
    description: Assign analytics permission sets
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSets
    options:
      api_names:
        - AnalyticsQueryService            
        - AnalyticsStoreUser               

  assign_additional_npc_perms:
    group: NPC Permissions & Access
    description: Assign additional NPC permission sets
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSets
    options:
      api_names:
        - AccessAccountingSubledgerGrowth  
        - ComplaintsManagementAccess       
        - ExplainabilityServicePSL         
        - IndustriesAssessmentPermissionSet 
        - ManageVolunteerData              
        - RunAccountingSubledgerJob        
        
  assign_fundraising_perms:
    group: NPC Permissions & Access
    description: Assign all fundraising-related permission sets to the current user.
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSets
    options:
      api_names:
        - FundraisingAccess
        - Fundraising_Admin
        - Fundraising_User
        - GroupMembershipPsl
        - ManageAccountingSubledger

  assign_grantmaking_perms:
    group: NPC Permissions & Access
    description: Assign grantmaking-related permission sets to the current user.
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSets
    options:
      api_names:
        - Grantmaking_Manager
        - GrantmakingManager

  assign_casemgmt_perms:
    group: NPC Permissions & Access
    description: Assign all case management-related permission sets to the current user.
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSets
    options:
      api_names:
        - CarePlansPermissionSetLicense
        - AdvancedProgramManagement
        - Investigative_Case_Management_Officer
        - Social_Program_Management_Caseworker
        - Benefit_Management_Caseworker
        - OutcomeManagement
        - DocumentChecklist
        - CaseReferralPsl
        - IndustriesAssessmentPermissionSet
        - BenefitManagementPermissionSetLicense

  assign_volunteermgmt_perms:
    group: NPC Permissions & Access
    description: Assign all volunteer management-related permission sets to the current user.
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSets
    options:
      api_names:
        - Volunteer_Management_User
        - GroupMembershipPsl
        - ManageVolunteerData

  assign_volunteerquickstart_perms:
    group: NPC Permissions & Access
    description: Assign Volunteer Quick Start-specific permission sets to the current user.
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSets
    options:
      api_names:
        - VMQS_Custom_Fields


  # ===========================
  # UI / App Navigation Tweaks
  # ===========================

  reorder_app_menu:
    group: NPC App Menu
    description: Set the default org-wide app menu order for general NPC exploration.
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/ReorderAppMenu.cls
      apex: applyOrgAppOrder();

  reorder_app_menu_volunteering:
    group: NPC App Menu
    description: Set the app menu order optimized for volunteering workflows.
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/ReorderAppMenu.cls
      apex: applyVolunteerAppOrder();

  reorder_app_menu_fundraising:
    group: NPC App Menu
    description: Set the app menu order optimized for fundraising workflows.
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/ReorderAppMenu.cls
      apex: applyFundraisingAppOrder();

  reorder_app_menu_grantmaking:
    group: NPC App Menu
    description: Set the app menu order optimized for grantmaking workflows.
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/ReorderAppMenu.cls
      apex: applyGrantmakingAppOrder();

  reorder_app_menu_programs:
    group: NPC App Menu
    description: Set the app menu order optimized for program management workflows.
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/ReorderAppMenu.cls
      apex: applyProgramManagementAppOrder();


  # ===========================
  # Sample / Demo Data
  # ===========================

  load_group_membership_data:
    group: NPC Sample Data
    class_path: cumulusci.tasks.bulkdata.load.LoadData
    options:
      mapping: datasets/group_membership/group_membership_mapping.yml
      sql_path: datasets/group_membership/group_membership_data.sql

  load_fundraising_data:
    group: NPC Sample Data
    class_path: cumulusci.tasks.bulkdata.load.LoadData
    options:
      mapping: datasets/fundraising/fundraising_mapping.yml
      sql_path: datasets/fundraising/fundraising_data.sql

  load_volunteer_management_data:
    group: NPC Sample Data
    class_path: cumulusci.tasks.bulkdata.load.LoadData
    options:
      mapping: datasets/volunteer_management/volunteer_mapping.yml
      sql_path: datasets/volunteer_management/volunteer_data.sql

  load_case_management_data:
    group: NPC Sample Data
    description: Loads case and program management data. Remember to manually enable Program Cohorts and Benefit Disbursements first if you want the complete dataset.
    class_path: cumulusci.tasks.bulkdata.load.LoadData
    options:
      mapping: datasets/case_management/casemgmt_mapping.yml
      sql_path: datasets/case_management/casemgmt_data.sql
      drop_missing_schema: True

  load_grantmaking_data:
    group: NPC Sample Data
    class_path: cumulusci.tasks.bulkdata.load.LoadData
    options:
      mapping: datasets/grantmaking/grantmaking_mapping.yml
      sql_path: datasets/grantmaking/grantmaking_data.sql

  load_philanthropic_research_data:
    group: NPC Sample Data
    class_path: cumulusci.tasks.bulkdata.load.LoadData
    options:
      mapping: datasets/philanthropic_research/philanthropic_research_mapping.yml
      sql_path: datasets/philanthropic_research/philanthropic_research_data.sql

  # ======================================
  # Volunteer Quick Start (VMSQ) Metadata
  # ======================================

  update_verification_status_values:
    group: NPC Volunteer Quick Start
    description: Add required Verification Status picklist values for Volunteer Quick Start.
    class_path: cumulusci.tasks.metadata_etl.AddValueSetEntries
    options:
      api_names: LPIPXMVerificationStatusTypeEnum
      entries:
        - fullName: Awaiting Approval
          label: Awaiting Approval
        - fullName: Pending
          label: Pending
        - fullName: Approved
          label: Approved
        - fullName: Not Approved
          label: Not Approved

  install_volunteer_quick_start_package:
    group: NPC Volunteer Quick Start
    description: Installs VMSQ package from Salesforce (https://github.com/SFDC-Assets/PSA-Volunteer-Management). To get install to succeed you must manually rename the Address/Examination layouts that conflict with unmanaged package install and enable History Tracking on Account. You shouldn't need to use this unless you want to compare the unpackaged metadata here with the original contents.
    class_path: cumulusci.tasks.salesforce.InstallPackageVersion
    options:  
      version: 04tfh000000ZNZd
      version_number: 1.3

  retrieve_volunteer_quick_start_components:
    group: NPC Volunteer Quick Start
    description: Retrieve all components in the VMSQ package from an org where it is installed (for comparison with unpackaged metadata).
    class_path: cumulusci.tasks.salesforce.RetrieveUnpackaged
    options:
      path: unpackaged/volunteersQuickStartRetrieve
      package_xml: unpackaged/volunteersQuickStartRetrieve/package.xml

  deploy_volunteers_quick_start_step1:
    group: NPC Volunteer Quick Start
    description: Deploy the first set of Volunteer Quick Start metadata (core objects and configuration).
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/volunteersQuickStart/step1

  deploy_volunteers_quick_start_step2:
    group: NPC Volunteer Quick Start
    description: Deploy the second set of Volunteer Quick Start metadata (remaining configuration).
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/volunteersQuickStart/step2

  # ======================================
  # Configuration from baseline configuration
  # ======================================
  deploy_shared_config:
    group: NPC Org Config
    description: Deploy configuration that is shared across features
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/feature-config/shared/


  deploy_fundraising_config:
    group: NPC Org Config
    description: Deploy fundraising-related configuration 
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/feature-config/fundraising/

  deploy_case_management_config:
    group: NPC Org Config
    description: Deploy programs and case management-related configuration 
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/feature-config/programs_and_case_mgmt/

  deploy_program_cohort_config:
    group: NPC Org Config
    description: Updates components of program management that are only valid if program cohorts are enabled
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/feature-config/program_cohorts/

  deploy_grantmaking_config:
    group: NPC Org Config
    description: Deploy grantmaking-related configuration 
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/feature-config/grantmaking

  # ======================================
  # Object & Field Metadata / References
  # ======================================

  list_org_objects:
    description: List API names and labels of every object in the org
    group: NPC Metadata Utilities
    class_path: tasks.list_org_objects.ListOrgObjects

  generate_object_reference:
    description: Generate a text data dictionary for selected objects.
    group: NPC Metadata Utilities
    class_path: tasks.object_reference.GenerateObjectReference

  generate_group_membership_reference:
    description: Generate a text data dictionary for household and group-related objects.
    options:
      objects: "Account,Contact,PartyRelationshipGroup,AccountContactRelation,AccountAccountRelation,ContactContactRelation,PartyRoleRelation"
      output_path: datasets/group_membership/group_membership_objects.yml

  generate_fundraising_object_reference:
    group: NPC Metadata Utilities
    description: Generate a text data dictionary for fundraising-related objects.
    class_path: tasks.object_reference.GenerateObjectReference
    options:
      objects: "Account,Contact,AccountContactRelation,Campaign,OutreachSourceCode,PaymentInstrument,GiftBatch,GiftDesignation,Opportunity,GiftCommitment,GiftCommitmentSchedule,GiftDefaultDesignation,GiftCmtChangeAttrLog,GiftTransaction,GiftTransactionDesignation,GiftRefund,GiftSoftCredit,GiftTribute,GiftEntry,Task"
      output_path: datasets/fundraising/fundraising_objects.yml

  generate_volunteer_object_reference:
    group: NPC Metadata Utilities
    description: Generate a text data dictionary for volunteer management-related objects.
    class_path: tasks.object_reference.GenerateObjectReference
    options:
      objects: "Account,Competency,JobPosition,JobPositionAssignment,JobPositionShift,Location,OperatingHours,PersonLocationAvailability,Position,PositionQualification,TimeSlot,VolunteerInitiative"
      output_path: datasets/volunteer_management/volunteer_objects.yml
  
  generate_group_membership_object_reference:
    group: NPC Metadata Utilities
    description: Generate a text data dictionary for household and party relationship group-related objects.
    class_path: tasks.object_reference.GenerateObjectReference
    options:
      objects: "Account,Contact,PartyRelationshipGroup,AccountContactRelation,AccountAccountRelation,ContactContactRelation,PartyRoleRelation"
      output_path: datasets/group_membership/group_membership_objects.yml

  generate_grantmaking_object_reference:
    group: NPC Metadata Utilities
    description: Generate a text data dictionary for grantmaking-related objects.
    class_path: tasks.object_reference.GenerateObjectReference
    options:
      objects: "User,Account,Contact,Contract,ApplicationDecision,ApplicationRenderMethod,ApplicationReview,ApplicationStageDefinition,ApplicationTimeline,PreliminaryApplicationRef,IndividualApplication,IndividualApplicationTask,PublicApplicationParticipant,DocumentChecklistItem,ActionPlanTemplate,ActionPlanTemplateVersion,ActionPlan,Budget,BudgetAllocation,BudgetCategory,BudgetCategoryValue,BudgetPeriod,FundingOpportunity,FundingAward,FundingAwardAmendment,FundingAwardRequirement,FundingAwardRqmtSection,FundingDisbursement,Program,OutcomeActivity,IndicatorAssignment,IndicatorPerformancePeriod"
      output_path: datasets/grantmaking/grantmaking_objects.yml

  generate_philanthropic_research_object_reference:
    group: NPC Metadata Utilities
    description: Generate a text data dictionary for philanthropic research-related objects.
    class_path: tasks.object_reference.GenerateObjectReference
    options:
      objects: "PartyCategory,ContactProfile,Account,Contact,ConstituentRole,PartyPhilanthropicRsrchPrfl,Case,PartyPhilanthropicAssessment,PartyPhilanthropicOccurrence,PartyPhilanthropicIndicator,PartyPhilanthropicMilestone,InteractionSummary,BusinessMilestone,PersonLifeEvent"
      output_path: datasets/philanthropic_research/philanthropic_research_objects.yml

  # ===========================
  # Data Processing Engine
  # ===========================

  # List all Data Processing Engine definitions
  list_dpe_definitions:
    description: List all Data Processing Engine definitions in the org
    class_path: tasks.dpe_tasks.ListDPEDefinitions
    options: {}

  # # List only active DPE definitions
  # list_active_dpe_definitions:
  #   description: List only active Data Processing Engine definitions
  #   class_path: tasks.dpe_tasks.ListDPEDefinitions
  #   options:
  #     active_only: True

  # # Retrieve DPE definitions from org
  # retrieve_dpe_definitions:
  #   description: Retrieve Data Processing Engine definitions from org to local files
  #   class_path: tasks.dpe_tasks.RetrieveDPEDefinitions
  #   options:
  #     path: dpe_definitions
  #     # definitions: "Definition1,Definition2"  # Optional: specify which ones

  # # Deploy DPE definitions to org
  # deploy_dpe_definitions:
  #   description: Deploy Data Processing Engine definitions from local files to org
  #   class_path: tasks.dpe_tasks.DeployDPEDefinitions
  #   options:
  #     path: dpe_definitions
  #     # definitions: "Definition1,Definition2"  # Optional: specify which ones

  # # Clone a DPE definition
  # clone_dpe_definition:
  #   description: Clone an existing DPE definition with a new name
  #   class_path: tasks.dpe_tasks.CloneDPEDefinition
  #   options:
  #     # These would be overridden at runtime:
  #     # source: "Source_Definition_Name"
  #     # target: "Target_Definition_Name"
  #     # label: "Target Definition Label"
  #     # description: "Optional description"
  #     activate: False  # Deploy as inactive by default

flows:

  # ===========================
  # Permission / Setup Flows
  # ===========================

  assign_all_npc_perms:
    group: NPC Permissions & Access
    description: Assign all NPC implementation guide-related permissions to the current user.
    steps:
      1:
        task: assign_fundraising_perms
      2:
        task: assign_grantmaking_perms
      3:
        task: assign_casemgmt_perms
      4:
        task: assign_volunteermgmt_perms
      5:
        task: assign_service_excellence_perms     
      6:
        task: assign_omnistudio_perms             
      7:
        task: assign_analytics_perms              
      8:
        task: assign_additional_npc_perms         
      
  # ===========================
  # Org Setup / Dev Flows
  # ===========================

  dev_org:
    group: NPC Org Setup
    description: Base dev org setup including NPC permissions and default app menu ordering.
    steps:
      90: 
        flow: assign_all_npc_perms
      91: 
        task: reorder_app_menu    

  load_all_datasets:
    group: Org Setup
    description: Loads all datasets into a single org. This will take a while to run, so consider using 
      individual datasets if that's all you need.
    steps:
      1: 
        task: load_group_membership_data
      2: 
        task: load_fundraising_data
      3: 
        task: load_volunteer_management_data
      4: 
        task: load_case_management_data
      5: 
        task: load_grantmaking_data
      6:
        task: load_philanthropic_research_data

  # ===========================
  # Volunteer Quick Start Flows
  # ===========================

  deploy_volunteer_quick_start:
    group: NPC Volunteer Quick Start
    description: Deploy the unpackaged Salesforce Volunteer Management Quick Start metadata.
    steps:
      1:
        task: update_verification_status_values
      2:
        task: assign_volunteermgmt_perms
      3:
        task: deploy_volunteers_quick_start_step1
      4:
        task: assign_volunteerquickstart_perms
      5:
        task: deploy_volunteers_quick_start_step2
      6: 
        task: reorder_app_menu_volunteering
  
  volunteer_quick_start_org:
    group: Org Setup
    description: Create a dev org with NPC defaults and then deploy Volunteer Quick Start metadata.
    steps:
      1: 
        flow: dev_org
      2:
        flow: deploy_volunteer_quick_start

  case_mgmt_org:
    group: Org Setup
    steps:
      1: 
        flow: dev_org
      2:
        task: deploy_shared_config
      3:
        task: deploy_case_management_config
      4: 
        task: load_case_management_data
      5: 
        task: reorder_app_menu_programs

  fundraising_org:
    group: Org Setup
    steps:
      1: 
        flow: dev_org
      2:
        task: deploy_shared_config
      3:
        task: deploy_fundraising_config
      4: 
        task: load_fundraising_data
      5: 
        task: reorder_app_menu_fundraising

# # Backup all DPE definitions
#   backup_dpe_definitions:
#     description: Retrieve and backup all DPE definitions to version control
#     steps:
#       1:
#         task: list_dpe_definitions
#       2:
#         task: retrieve_dpe_definitions

#   # Deploy DPE definitions after customization
#   deploy_custom_dpe:
#     description: Deploy customized DPE definitions to org
#     steps:
#       1:
#         task: deploy_dpe_definitions
#       2:
#         task: list_dpe_definitions