minimum_cumulusci_version: '4.6.0'
project:
    name: npc-exploration
    package:
        name: npc-exploration
        api_version: '64.0'
    git:
        default_branch: 'main'
    source_format: sfdx

tasks:
  # permissions
  assign_psl_kitchen_sink:
    description: Assigns basically every PSL that looked relevant to NPC for the scratch org definition. This should be revised as requirements become clearer.
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSetLicenses 
    options:
      api_names:
        - AccountingSubledgerAdminPsl
        - AccountingSubledgerAutomationPsl
        - AccountingSubledgerGrowthBasePsl
        - ActionPlansPsl
        - AnalyticsQueryServicePsl
        - BenefitDisbursementPermissionSetLicense
        - BenefitManagementPermissionSetLicense
        - CarePlansPermissionSetLicense
        - CaseProceedingsPSL
        - CaseReferralPsl
        - ComplaintsManagementPsl
        - CompliantDataSharingPsl
        - DataProcessingEnginePsl
        - DocumentChecklistPsl
        - DynamicAssessmentPsl
        - EinsteinAnalyticsPlusPsl
        - EvidenceManagementPSL
        - FieldServiceDispatcherPsl
        - FieldServiceMobilePsl
        - FieldServiceSchedulingPsl
        - FieldServiceStandardPsl
        - FundraisingAccessPsl
        - GrantmakingPsl
        - GroupMembershipPsl
        - IndustriesARCPsl
        - IndustriesAssessmentPsl
        - IndustriesInteractionSummaryPsl
        - IndustriesSalesExcellencePsl
        - IndustriesServiceExcellencePsl
        - InsightsBuilderPsl
        - LifeEventsAccessPSL
        - OmniStudioDesigner
        - OmniStudioRuntime
        - OutcomeManagementPsl
        - ProgramManagementPsl
        - Salesforce_org_AccountingSubledgerPsl
        - Salesforce_org_NonprofitCloudCaseManagementPsl
        - SonicEmbeddedStorePsl
        - SurveyCreatorPsl
        - Volunteer_Management_User

  assign_fundraising_perms:
    description: Assign all fundraising-related permission sets to the current user
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSets
    options:
      api_names:
        - FundraisingAccess
        - Fundraising_Admin
        - Fundraising_User
        - GroupMembershipPsl
        - ManageAccountingSubledger

  assign_grantmaking_perms:
    description: Assign grantmaking-related permission sets to the current user
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSets
    options:
      api_names:
        - Grantmaking_Manager
        - GrantmakingManager

  assign_casemgmt_perms:
    description: Assign all case management-related permission sets to the current user
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSets
    options:
      api_names:
        - CarePlansPermissionSetLicense
        - AdvancedProgramManagement
        - Investigative_Case_Management_Officer
        - Social_Program_Management_Caseworker
        - Benefit_Management_Caseworker
        - OutcomeManagement
        - DocumentChecklist
        - CaseReferralPsl
        - IndustriesAssessmentPermissionSet
        - BenefitManagementPermissionSetLicense

  assign_volunteermgmt_perms:
    description: Assign all volunteer management-related permission sets to the current user
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSets
    options:
      api_names:
        - Volunteer_Management_User
        - GroupMembershipPsl
        - ManageVolunteerData

  assign_volunteerquickstart_perms:
    description: Assign all volunteer management-related permission sets to the current user
    class_path: cumulusci.tasks.salesforce.users.permsets.AssignPermissionSets
    options:
      api_names:
        - VMQS_Custom_Fields

  load_volunteer_sample_data:
    description: "Loads volunteer sample data into the org using volunteer_mapping.yml and volunteer_storydata.sql"
    class_path: cumulusci.tasks.bulkdata.load.LoadData
    options:
      mapping: datasets/volunteer_mapping.yml
      sql_path: datasets/volunteer_storydata.sql

  # ui
  reorder_app_menu:
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/ReorderAppMenu.cls
      apex: applyOrgAppOrder();

  reorder_app_menu_volunteering:
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/ReorderAppMenu.cls
      apex: applyVolunteerAppOrder();

  reorder_app_menu_fundraising:
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/ReorderAppMenu.cls
      apex: applyFundraisingAppOrder();

  reorder_app_menu_grantmaking:
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/ReorderAppMenu.cls
      apex: applyGrantmakingAppOrder();

  reorder_app_menu_programs:
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      path: scripts/ReorderAppMenu.cls
      apex: applyProgramManagementAppOrder();
  
  # sample data
  load_sample_data:
    class_path: cumulusci.tasks.sample_data.load_sample_data.LoadSampleData
    options:
      snowfakery_recipe: datasets/default/default.recipe.yml

  # volunteer quick start setup
  update_verification_status_values:
    class_path: cumulusci.tasks.metadata_etl.AddValueSetEntries
    options:
      api_names: LPIPXMVerificationStatusTypeEnum
      entries:
        - fullName: Awaiting Approval
          label: Awaiting Approval
        - fullName: Pending
          label: Pending
        - fullName: Approved
          label: Approved
        - fullName: Not Approved
          label: Not Approved
    
  install_volunteer_quick_start_package:
    description: Installs VMSQ package from Salesforce (https://github.com/SFDC-Assets/PSA-Volunteer-Management). To get install to succeed you must manually rename the Address/Examination layouts that conflict with unmanaged package install and enable History Tracking on Account. You shouldn't need to use this unless you want to compare the unpackaged metadata here with the original contents.
    class_path: cumulusci.tasks.salesforce.InstallPackageVersion
    options:  
      version: 04tfh000000ZNZd
      version_number: 1.3

  retrieve_volunteer_quick_start_components:
    description: Retrieves all components in the VMSQ package if you run it against an org with the package installed. Note that the package.xml file for retrieve contains some components like compactLayout that are embedded in object files, so the manifest for retrieve doesn't exactly match the manifest for deploy.
    class_path: cumulusci.tasks.salesforce.RetrieveUnpackaged
    options:
      path: unpackaged/volunteersQuickStartRetrieve
      package_xml: unpackaged/volunteersQuickStartRetrieve/package.xml

  deploy_volunteers_quick_start_step1:
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/volunteersQuickStart/step1

  deploy_volunteers_quick_start_step2:
    class_path: cumulusci.tasks.salesforce.Deploy
    options:
      path: unpackaged/volunteersQuickStart/step2


flows:
  assign_all_npc_perms:
    description: Assign all NPC implementation-guide permissions to me
    steps:
      1:
        task: assign_fundraising_perms
      2:
        task: assign_grantmaking_perms
      3:
        task: assign_casemgmt_perms
      4:
        task: assign_volunteermgmt_perms

  dev_org:
    steps:
      90: 
        flow: assign_all_npc_perms
      91: 
        task: reorder_app_menu    

  deploy_volunteer_quick_start:
    description: Deploys contents of Salesforce's open source Volunteer Management Quick Start
    steps:
      1:
        task: update_verification_status_values
      2:
        task: assign_volunteermgmt_perms
      3:
        task: deploy_volunteers_quick_start_step1
      4:
        task: assign_volunteerquickstart_perms
      5:
        task: deploy_volunteers_quick_start_step2
      6: 
        task: reorder_app_menu
      7: 
        task: load_volunteer_sample_data
  
  volunteer_quick_start_org:
    steps:
      1: 
        flow: dev_org
      2:
        flow: deploy_volunteer_quick_start
    
      
